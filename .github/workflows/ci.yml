name: CI
on:
  push:
    branches: ["**"]
  pull_request:
    - dev
    - main

jobs:
  check_repository:
      name: check_repository
      runs-on: ubuntu-latest
      steps:
          - name: checkout
            uses: actions/checkout@v4
          - name: is a mirror rÃ©pository
            run: |
              git remote -v | awk '{print $2}' > test.txt
              rep=$(head -n 1 test.txt)
              modified=$(echo "$rep" | sed 's/git@github.com:/https:\/\/github.com\//g')
              modified=$(echo "$rep" | sed 's/https:\/\/github.com\//git@github.com:/g')
              echo "$modified.git"
              if [[ "${modified}.git" == ${{ vars.MIRROR_URL }} ]]
              then
                  exit 1
              else
                  echo "Good repository"
              fi

  push_to_mirror:
      runs-on: ubuntu-latest
      if: github.event_name == 'push'
      needs: [check_repository, backend, frontend]
      steps:
          - name: checkout
            uses: actions/checkout@v4
            with:
              fetch-depth: 0
          - name: mirror to epitech repo
            uses: pixta-dev/repository-mirroring-action@v1
            with:
              target_repo_url: ${{ vars.MIRROR_URL }}
              ssh_private_key: ${{ secrets.GIT_SSH_PRIVATE_KEY }}